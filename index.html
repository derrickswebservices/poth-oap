<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poth OAP Management | Director Dashboard v4.0</title>

    <!-- Typography & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --poth-maroon: #7B1113;
            --poth-maroon-light: #a31d20;
            --poth-gold: #FFD700;
            --poth-gold-dim: #c9aa00;
            --bg-deep: #0f172a;
            --bg-surface: #ffffff;
            --bg-canvas: #f1f5f9;
            --text-primary: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            
            --absence: #ef4444;
            --practice: #3b82f6;
            --rehearsal: #10b981;
            --clinic: #f59e0b;

            --radius-main: 24px;
            --radius-inner: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg-canvas); 
            color: var(--text-primary);
            height: 100vh;
            display: grid;
            grid-template-columns: 80px 1fr;
            overflow: hidden;
        }

        /* Director Authorized Mode Styling */
        body.is-director-authorized { 
            --bg-canvas: #020617; 
            --bg-surface: #0f172a; 
            --text-primary: #f8fafc;
            --border: #1e293b;
            --text-muted: #94a3b8;
        }

        /* 1. NAVIGATION RAIL */
        nav.nav-rail {
            background: var(--poth-maroon);
            border-right: 4px solid var(--poth-gold);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px 0;
            gap: 30px;
            z-index: 100;
        }

        .rail-brand {
            width: 45px;
            height: 45px;
            background: var(--poth-gold);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--poth-maroon);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .rail-btn {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
            position: relative;
        }

        .rail-btn:hover, .rail-btn.active { 
            color: white; 
            background: rgba(255,255,255,0.15); 
        }
        
        .rail-btn.active::after {
            content: '';
            position: absolute;
            left: -25px;
            width: 4px;
            height: 24px;
            background: var(--poth-gold);
            border-radius: 0 4px 4px 0;
        }

        /* 2. MAIN LAYOUT */
        .app-shell {
            display: grid;
            grid-template-columns: 1fr 340px;
            height: 100vh;
        }

        main.content-area {
            padding: 35px;
            overflow-y: auto;
            position: relative;
        }

        aside.control-side {
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 35px 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }

        /* 3. HEADERS & TYPOGRAPHY */
        .workspace-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .workspace-title h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; letter-spacing: -1px; }
        .workspace-title p { color: var(--text-muted); font-size: 1.1rem; }

        .section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            font-weight: 800;
            margin-bottom: 5px;
        }

        /* 4. CARDS & WIDGETS */
        .poth-card {
            background: var(--bg-surface);
            border-radius: var(--radius-main);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .stat-card {
            background: var(--bg-surface);
            padding: 20px;
            border-radius: var(--radius-inner);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--bg-canvas);
        }

        .stat-info .val { font-size: 1.5rem; font-weight: 800; line-height: 1; }
        .stat-info .lab { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); }

        /* 5. BUTTONS AND CONTROLS */
        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .btn-primary { background: var(--poth-maroon); color: white; }
        .btn-primary:hover { background: var(--poth-maroon-light); transform: translateY(-2px); }

        .btn-accent { background: var(--poth-gold); color: var(--poth-maroon); }
        .btn-accent:hover { filter: brightness(1.1); transform: translateY(-2px); }

        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-primary); }
        .btn-outline:hover { background: var(--bg-canvas); }

        /* 6. LIST STYLING */
        .schedule-item {
            background: var(--bg-surface);
            border-radius: var(--radius-inner);
            padding: 20px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 80px 1fr auto;
            align-items: center;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .schedule-item:hover { transform: scale(1.01); border-color: var(--poth-maroon); }
        
        .item-date { text-align: center; border-right: 2px solid var(--border); }
        .item-date .day { font-size: 1.8rem; font-weight: 900; display: block; line-height: 1; color: var(--poth-maroon); }
        .item-date .month { font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--text-muted); }

        .item-body { padding: 0 20px; }
        .item-body h4 { font-size: 1.1rem; font-weight: 700; }
        .item-badge { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; margin-top: 5px; }

        /* 7. CALENDAR SKIN */
        .fc { --fc-border-color: var(--border); color: var(--text-primary); font-family: 'Outfit', sans-serif; }
        .fc-theme-standard th { background: var(--poth-maroon); color: white; padding: 12px; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        .fc-day-today { background: rgba(255, 215, 0, 0.05) !important; }
        .fc-event { border: none !important; border-radius: 8px !important; padding: 5px 8px !important; font-weight: 600 !important; cursor: pointer; }

        /* 8. MODAL ENGINE */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(10px);
            z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px;
        }

        .modal-card {
            background: var(--bg-surface); color: var(--text-primary);
            width: 100%; max-width: 500px; border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow: hidden;
            animation: modalIn 0.4s ease;
        }

        @keyframes modalIn { from { transform: scale(0.9) translateY(20px); opacity: 0; } }

        .modal-header { padding: 30px; background: var(--poth-maroon); color: white; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Playfair Display'; margin: 0; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; background: var(--bg-canvas); border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

        .form-input { 
            width: 100%; padding: 16px; border-radius: 12px; border: 2px solid var(--border); 
            background: var(--bg-canvas); color: var(--text-primary); font-family: inherit; margin-bottom: 15px; 
        }

        .form-input:focus { outline: none; border-color: var(--poth-maroon); background: var(--bg-surface); }
        
        /* 9. UTILS */
        .member-exclusive { display: flex; }
        .director-exclusive { display: none; }
        body.is-director-authorized .member-exclusive { display: none !important; }
        body.is-director-authorized .director-exclusive { display: flex !important; }

        #app-loader { position: fixed; inset: 0; background: var(--poth-maroon); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--poth-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast Popup */
        #toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            padding: 15px 30px; background: var(--bg-deep); color: white; font-weight: 700;
            border-radius: 50px; display: none; z-index: 3000; border: 2px solid var(--poth-gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

    </style>
</head>
<body id="production-app">

    <!-- Loading Screen -->
    <div id="app-loader">
        <div class="spinner"></div>
        <p style="color:white; margin-top:20px; font-weight:800; letter-spacing:1px; text-transform:uppercase;">Loading Timeline...</p>
    </div>

    <!-- 1. NAVIGATION RAIL -->
    <nav class="nav-rail">
        <div class="rail-brand">
            <i class="fas fa-masks-theater"></i>
        </div>
        <div class="rail-btn active" id="rail-calendar" onclick="activateView('calendar')" title="Calendar View">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="rail-btn" id="rail-list" onclick="activateView('schedule')" title="Timeline View">
            <i class="fas fa-list-ul"></i>
        </div>
        
        <div style="flex-grow: 1;"></div>

        <div class="rail-btn member-exclusive" onclick="openManagedModal('modal-director-login', true)" title="Director Login">
            <i class="fas fa-lock"></i>
        </div>
        <div class="rail-btn director-exclusive" onclick="terminateSession()" title="Director Logout" style="color:var(--poth-gold)">
            <i class="fas fa-power-off"></i>
        </div>
    </nav>

    <!-- 2. MAIN WORKSPACE -->
    <div class="app-shell">
        
        <main class="content-area">
            <div class="workspace-header">
                <div class="workspace-title">
                    <p id="sub-header-text">Poth High School OAP</p>
                    <h1 id="app-title-text">Production Central</h1>
                </div>
            </div>

            <!-- View: Calendar -->
            <div id="view-calendar-container" class="poth-card" style="height: calc(100% - 130px);">
                <div id="main-calendar-widget" style="height: 100%;"></div>
            </div>

            <!-- View: Schedule List -->
            <div id="view-schedule-container" style="display: none;">
                <div id="schedule-render-sink">
                    <!-- Dynamic List Cards -->
                </div>
            </div>
        </main>

        <aside class="control-side">
            <section>
                <div class="section-header">Live Statistics</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="stat-card">
                        <div class="stat-icon" style="color:var(--poth-maroon)"><i class="fas fa-rocket"></i></div>
                        <div class="stat-info">
                            <span class="val" id="count-total">0</span>
                            <span class="lab">Total Activities</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="color:var(--absence)"><i class="fas fa-user-slash"></i></div>
                        <div class="stat-info">
                            <span class="val" id="count-absence">0</span>
                            <span class="lab">Absences Today</span>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <div class="section-header">Operational Actions</div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-primary member-exclusive" onclick="openManagedModal('modal-report-absence', true)">
                        <i class="fas fa-user-xmark"></i> Report Absence
                    </button>
                    <button class="btn btn-accent director-exclusive" onclick="openManagedModal('modal-create-event', true)">
                        <i class="fas fa-plus-circle"></i> Create Activity
                    </button>
                    <button class="btn btn-outline" onclick="synchronizeProductionData()">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                </div>
            </section>

            <section>
                <div class="section-header">Category Legend</div>
                <div class="poth-card" style="padding: 15px; border-radius: 12px;">
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div style="font-size:0.85rem; display:flex; align-items:center; gap:10px;"><div style="width:10px; height:10px; border-radius:50%; background:var(--practice)"></div> Cast Practice</div>
                        <div style="font-size:0.85rem; display:flex; align-items:center; gap:10px;"><div style="width:10px; height:10px; border-radius:50%; background:var(--rehearsal)"></div> Production Tech</div>
                        <div style="font-size:0.85rem; display:flex; align-items:center; gap:10px;"><div style="width:10px; height:10px; border-radius:50%; background:var(--clinic)"></div> Expert Clinic</div>
                        <div style="font-size:0.85rem; display:flex; align-items:center; gap:10px;"><div style="width:10px; height:10px; border-radius:50%; background:var(--absence)"></div> Shared Absence</div>
                    </div>
                </div>
            </section>
        </aside>
    </div>

    <!-- MODAL OVERLAYS -->

    <!-- Modal: Login -->
    <div id="modal-director-login" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>Director Logic</h2>
                <i class="fas fa-times" onclick="openManagedModal('modal-director-login', false)" style="cursor:pointer"></i>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:20px; font-size:0.9rem; color:var(--text-muted);">Confirm identity to access administrative production tools.</p>
                <input type="password" id="field-director-pass" class="form-input" placeholder="Authorization Token">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" style="width:auto" onclick="openManagedModal('modal-director-login', false)">Cancel</button>
                <button class="btn btn-primary" style="width:auto" onclick="authorizeDirector()">Authorize</button>
            </div>
        </div>
    </div>

    <!-- Modal: Absence Report -->
    <div id="modal-report-absence" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2>OAP Absence Reporter</h2>
                <i class="fas fa-times" onclick="openManagedModal('modal-report-absence', false)" style="cursor:pointer"></i>
            </div>
            <form onsubmit="handleAbsenceUpload(event)">
                <div class="modal-body">
                    <input type="text" id="abs-field-name" class="form-input" placeholder="Student Name" required>
                    <input type="date" id="abs-field-date" class="form-input" required>
                    <textarea id="abs-field-notes" class="form-input" rows="3" placeholder="Reason/Details"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" style="width:auto" onclick="openManagedModal('modal-report-absence', false)">Back</button>
                    <button type="submit" class="btn btn-primary" style="width:auto">Post Absence</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create Activity -->
    <div id="modal-create-event" class="modal-overlay">
        <div class="modal-card" style="max-width: 600px;">
            <div class="modal-header">
                <h2>New Activity</h2>
                <i class="fas fa-times" onclick="openManagedModal('modal-create-event', false)" style="cursor:pointer"></i>
            </div>
            <form onsubmit="handleActivityUpload(event)">
                <div class="modal-body">
                    <input type="text" id="evt-field-title" class="form-input" placeholder="Title (e.g., Run Through Act 2)" required>
                    <select id="evt-field-type" class="form-input">
                        <option value="practice">Full Cast Practice</option>
                        <option value="rehearsal">Tech/Dress Rehearsal</option>
                        <option value="clinic">Guest Director Clinic</option>
                    </select>
                    <input type="date" id="evt-field-start" class="form-input" required>
                    
                    <div style="background:var(--bg-canvas); padding:20px; border-radius:15px; margin-bottom:15px;">
                        <label style="font-size:0.75rem; font-weight:800; text-transform:uppercase; color:var(--text-muted); display:block; margin-bottom:10px;">Recurrence Logic</label>
                        <select id="evt-field-recur" class="form-input" onchange="toggleRepeatLogic(this.value)">
                            <option value="none">One-time entry</option>
                            <option value="weekly">Repeat Weekly</option>
                        </select>
                        <div id="logic-recur-end" style="display:none;">
                            <input type="date" id="evt-field-until" class="form-input">
                        </div>
                    </div>
                    
                    <textarea id="evt-field-desc" class="form-input" rows="2" placeholder="Director Notes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" style="width:auto" onclick="openManagedModal('modal-create-event', false)">Discard</button>
                    <button type="submit" class="btn btn-primary" style="width:auto">Publish Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Inspector -->
    <div id="modal-entry-inspect" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="inspect-title-text">Details</h2>
                <i class="fas fa-times" onclick="openManagedModal('modal-entry-inspect', false)" style="cursor:pointer"></i>
            </div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <span id="inspect-type-label" style="font-weight:900; letter-spacing:1px; text-transform:uppercase;"></span>
                    <span id="inspect-date-label" style="font-weight:700; color:var(--text-muted)"></span>
                </div>
                <div id="inspect-body-text" style="color:var(--text-primary); line-height:1.6; font-size:1.1rem;"></div>
            </div>
            <div class="modal-footer">
                <div class="director-exclusive" style="width: 100%;">
                    <button class="btn btn-primary" style="background:#ef4444;" onclick="executeDeactivation()">Delete Record</button>
                </div>
                <button class="btn btn-outline" style="width:auto" onclick="openManagedModal('modal-entry-inspect', false)">Close</button>
            </div>
        </div>
    </div>

    <!-- Feedback Layer -->
    <div id="toast"></div>

    <script>
        const SUPABASE_PROJECT_URL = 'https://tgrlrejnngmmofqfunmv.supabase.co';
        const SUPABASE_ANON_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRncmxyZWpubmdtbW9mcWZ1bm12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Mzk1MDYsImV4cCI6MjA4NDUxNTUwNn0.lNNjZggoIb8zBH1T-t5wP8l5xphdXXmHCX9vKXA1xI4';
        
        let supabaseClientInstance;
        let mainCalendarInstance;
        let productionRecordsCache = [];
        let isAuthorizedDirector = false;
        let focusedEntryId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            initializeDatabase();
            initializeCalendarWidget();
            await synchronizeProductionData();
            
            setTimeout(() => {
                document.getElementById('app-loader').style.display = 'none';
            }, 800);
        });

        function initializeDatabase() {
            supabaseClientInstance = supabase.createClient(SUPABASE_PROJECT_URL, SUPABASE_ANON_API_KEY);
        }

        function initializeCalendarWidget() {
            const calendarEl = document.getElementById('main-calendar-widget');
            mainCalendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                events: (info, callback) => {
                    const mappedEvents = productionRecordsCache.map(entry => ({
                        id: entry.id,
                        title: entry.type === 'absence' ? `X: ${entry.title}` : entry.title,
                        start: entry.start_time,
                        className: `status-${entry.type}`,
                        backgroundColor: `var(--${entry.type})`,
                        borderColor: `var(--${entry.type})`,
                    }));
                    callback(mappedEvents);
                },
                eventClick: (info) => openInspectorPortal(info.event.id),
                height: '100%',
                displayEventTime: false
            });
            mainCalendarInstance.render();
        }

        async function synchronizeProductionData() {
            const { data } = await supabaseClientInstance.from('events').select('*').order('start_time', { ascending: true });
            if (data) {
                productionRecordsCache = data;
                mainCalendarInstance.refetchEvents();
                renderProductionScheduleList();
                recalculateInternalMetrics();
            }
        }

        async function uploadProductionRecord(payload) {
            const { error } = await supabaseClientInstance.from('events').insert(Array.isArray(payload) ? payload : [payload]);
            if (!error) {
                fireToast("Schedule Updated.");
                await synchronizeProductionData();
            }
        }

        async function executeDeactivation() {
            if (!confirm("Remove this activity permanently?")) return;
            const { error } = await supabaseClientInstance.from('events').delete().eq('id', focusedEntryId);
            if (!error) {
                fireToast("Record Deleted.");
                openManagedModal('modal-entry-inspect', false);
                await synchronizeProductionData();
            }
        }

        function activateView(target) {
            const cal = document.getElementById('view-calendar-container');
            const list = document.getElementById('view-schedule-container');
            
            document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`rail-${target}`).classList.add('active');

            if (target === 'calendar') {
                cal.style.display = 'block'; list.style.display = 'none';
                mainCalendarInstance.updateSize();
            } else {
                cal.style.display = 'none'; list.style.display = 'block';
            }
        }

        function authorizeDirector() {
            if (document.getElementById('field-director-pass').value === "OAP2026!") {
                isAuthorizedDirector = true;
                document.getElementById('production-app').classList.add('is-director-authorized');
                document.getElementById('app-title-text').innerText = "Director Suite";
                openManagedModal('modal-director-login', false);
                fireToast("Clearance Granted");
            } else fireToast("Access Denied");
        }

        function terminateSession() {
            isAuthorizedDirector = false;
            document.getElementById('production-app').classList.remove('is-director-authorized');
            document.getElementById('app-title-text').innerText = "Production Central";
            fireToast("Director Logged Out");
        }

        function toggleRepeatLogic(v) {
            document.getElementById('logic-recur-end').style.display = (v === 'weekly' ? 'block' : 'none');
        }

        function handleAbsenceUpload(e) {
            e.preventDefault();
            uploadProductionRecord({
                title: document.getElementById('abs-field-name').value,
                start_time: document.getElementById('abs-field-date').value,
                description: document.getElementById('abs-field-notes').value,
                type: 'absence'
            });
            openManagedModal('modal-report-absence', false);
            e.target.reset();
        }

        function handleActivityUpload(e) {
            e.preventDefault();
            const startStr = document.getElementById('evt-field-start').value;
            const recurType = document.getElementById('evt-field-recur').value;
            const untilStr = document.getElementById('evt-field-until').value;
            
            if (recurType === 'weekly' && untilStr) {
                let batch = [];
                let cursor = new Date(startStr + 'T00:00:00');
                const end = new Date(untilStr + 'T23:59:59');
                while (cursor <= end) {
                    batch.push({
                        title: document.getElementById('evt-field-title').value,
                        type: document.getElementById('evt-field-type').value,
                        start_time: cursor.toISOString().split('T')[0],
                        description: document.getElementById('evt-field-desc').value
                    });
                    cursor.setDate(cursor.getDate() + 7);
                }
                uploadProductionRecord(batch);
            } else {
                uploadProductionRecord({
                    title: document.getElementById('evt-field-title').value,
                    type: document.getElementById('evt-field-type').value,
                    start_time: startStr,
                    description: document.getElementById('evt-field-desc').value
                });
            }
            openManagedModal('modal-create-event', false); e.target.reset();
        }

        function renderProductionScheduleList() {
            const sink = document.getElementById('schedule-render-sink');
            sink.innerHTML = productionRecordsCache.map(entry => {
                const date = new Date(entry.start_time + 'T00:00:00');
                return `
                <div class="schedule-item">
                    <div class="item-date">
                        <span class="day">${date.getDate()}</span>
                        <span class="month">${date.toLocaleDateString('en-US', { month: 'short' })}</span>
                    </div>
                    <div class="item-body">
                        <h4>${entry.title}</h4>
                        <span class="item-badge" style="background:var(--${entry.type}); color:white;">${entry.type}</span>
                    </div>
                    <div>
                        <button class="btn btn-outline" style="padding:10px;" onclick="openInspectorPortal('${entry.id}')"><i class="fas fa-eye"></i></button>
                    </div>
                </div>`;
            }).join('') || '<div style="text-align:center; padding:100px; opacity:0.3;">Timeline Empty</div>';
        }

        function openInspectorPortal(id) {
            const entry = productionRecordsCache.find(x => x.id === id);
            if (!entry) return;
            focusedEntryId = id;
            document.getElementById('inspect-title-text').innerText = entry.title;
            document.getElementById('inspect-type-label').innerText = entry.type;
            document.getElementById('inspect-type-label').style.color = `var(--${entry.type})`;
            document.getElementById('inspect-date-label').innerText = entry.start_time;
            document.getElementById('inspect-body-text').innerText = entry.description || "Production Entry: No additional notes.";
            openManagedModal('modal-entry-inspect', true);
        }

        function recalculateInternalMetrics() {
            document.getElementById('count-total').innerText = productionRecordsCache.length;
            document.getElementById('count-absence').innerText = productionRecordsCache.filter(x => x.type === 'absence').length;
        }

        function openManagedModal(id, v) { document.getElementById(id).style.display = v ? 'flex' : 'none'; }

        function fireToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

    </script>
</body>
</html>
